import logging
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, filters

# ---------------- CONFIGURATION ---------------- #
TOKEN = '8489791050:AAGLhphzMclt3XekEAwufVU_is4VqstBzwU'
OWNER_ID = 7639633018  # ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ID ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï
TARGET_GROUP_ID = -1003621584117 # ‡¥ó‡µç‡¥∞‡µÇ‡¥™‡µç‡¥™‡µç ID ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï
LOOP_TIME = 600 # 10 ‡¥Æ‡¥ø‡¥®‡¥ø‡¥±‡µç‡¥±‡µç (‡¥∏‡µÜ‡¥ï‡µç‡¥ï‡µª‡¥°‡¥ø‡µΩ)
# ----------------------------------------------- #

import logging
import asyncio
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, filters

# ----------- CONFIGURATION (Heroku Settings) -----------
# Heroku Settings-‡µΩ ‡¥™‡µã‡¥Ø‡¥ø ‡¥à ‡¥™‡µá‡¥∞‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ ‡¥µ‡¥æ‡¥≤‡µç‡¥Ø‡µÇ‡¥∏‡µç ‡¥®‡µΩ‡¥ï‡¥£‡¥Ç
TOKEN = os.getenv('8489791050:AAGLhphzMclt3XekEAwufVU_is4VqstBzwU')
OWNER_ID = int(os.getenv('7639633018'))
TARGET_GROUP_ID = int(os.getenv('-1003621584117'))
LOOP_TIME = 600 # 10 minutes
# -------------------------------------------------------

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

current_loop_task = None
last_loop_message_id = None

async def handle_dm_post(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global current_loop_task, last_loop_message_id
    
    if update.effective_chat.type != 'private' or update.effective_user.id != OWNER_ID:
        return

    msg = update.message
    full_text = msg.text or msg.caption or ""
    
    if full_text.lower() == "stop":
        if current_loop_task:
            current_loop_task.cancel()
            current_loop_task = None
            last_loop_message_id = None
            await msg.reply_text("üõë ‡¥≤‡µÇ‡¥™‡µç‡¥™‡µç ‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡¥ø.")
        return

    clean_text = full_text.replace("#loop", "").replace("#Loop", "").strip()
    post_content = clean_text
    reply_markup = None

    if "===" in clean_text:
        try:
            parts = clean_text.split("===", 1)
            post_content = parts[0].strip()
            button_section = parts[1].strip()
            keyboard = []
            for line in button_section.split('\n'):
                if "|" in line:
                    btn_text, btn_url = line.split("|", 1)
                    keyboard.append([InlineKeyboardButton(btn_text.strip(), url=btn_url.strip())])
            if keyboard:
                reply_markup = InlineKeyboardMarkup(keyboard)
        except:
            pass

    if "#loop" in full_text.lower():
        if current_loop_task:
            current_loop_task.cancel()
        await msg.reply_text("üîÑ ‡¥≤‡µÇ‡¥™‡µç‡¥™‡µç ‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡¥ø!")
        current_loop_task = asyncio.create_task(run_loop(context, msg, post_content, reply_markup))
    else:
        await send_post(context, msg, post_content, reply_markup)
        await msg.reply_text("‚úÖ ‡¥Ö‡¥Ø‡¥ö‡µç‡¥ö‡µÅ.")

async def send_post(context, original_msg, content, markup):
    if original_msg.photo:
        return await context.bot.send_photo(chat_id=TARGET_GROUP_ID, photo=original_msg.photo[-1].file_id, caption=content, reply_markup=markup)
    else:
        return await context.bot.send_message(chat_id=TARGET_GROUP_ID, text=content, reply_markup=markup)

async def run_loop(context, original_msg, content, markup):
    global last_loop_message_id
    while True:
        try:
            if last_loop_message_id:
                try: await context.bot.delete_message(chat_id=TARGET_GROUP_ID, message_id=last_loop_message_id)
                except: pass
            sent_msg = await send_post(context, original_msg, content, markup)
            last_loop_message_id = sent_msg.message_id
        except Exception as e:
            print(f"Error: {e}")
        await asyncio.sleep(LOOP_TIME)

if __name__ == '__main__':
    application = ApplicationBuilder().token(TOKEN).build()
    application.add_handler(MessageHandler(filters.ChatType.PRIVATE & (filters.TEXT | filters.PHOTO), handle_dm_post))
    application.run_polling()